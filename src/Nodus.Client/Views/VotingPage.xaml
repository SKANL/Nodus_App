<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Nodus.Client.ViewModels"
             x:Class="Nodus.Client.Views.VotingPage"
             Title="Evaluar Proyecto"
             BackgroundColor="#0F172A">

    <Grid RowDefinitions="Auto, *, Auto">

        <!-- ══ PROJECT HEADER ══════════════════════════════════════ -->
        <Grid Grid.Row="0" RowDefinitions="Auto,Auto,Auto,Auto" Padding="24,52,24,12" BackgroundColor="#0F172A">

            <!-- Row 0: Back button + Category pill in same row -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,*">
                <!-- "Cambiar proyecto" back button — Fix: Nielsen #3 (User Control & Freedom).
                     A judge who accidentally scans the wrong project was previously
                     trapped on this screen with no visible exit. This ghost button
                     provides a clear, low-effort escape without cluttering the CTA area. -->
                <Button Grid.Column="0"
                        Text="← Cambiar"
                        Command="{Binding CancelVoteCommand}"
                        BackgroundColor="Transparent"
                        TextColor="#6366F1"
                        FontSize="13" FontAttributes="Bold"
                        HeightRequest="36"
                        Padding="0,0,12,0"
                        HorizontalOptions="Start"
                        SemanticProperties.Hint="Cancelar esta evaluación y volver al escáner" />

                <!-- Category pill -->
                <Border Grid.Column="1" StrokeShape="RoundRectangle 20"
                        BackgroundColor="#1E1B4B" Padding="12,6"
                        HorizontalOptions="Start"
                        VerticalOptions="Center">
                    <Label Text="{Binding CurrentProject.Category, TargetNullValue='—'}"
                           TextColor="#A5B4FC" FontSize="13" FontAttributes="Bold"
                           CharacterSpacing="0.5" />
                </Border>
            </Grid>

            <!-- Row 1: Project name -->
            <Label Grid.Row="1" Text="{Binding CurrentProject.Name, TargetNullValue='Cargando...'}"
                   FontSize="26" FontAttributes="Bold" TextColor="White"
                   Margin="0,10,0,12" MaxLines="2" LineBreakMode="TailTruncation" />

            <!-- Row 2: Progress row — Fix: Nielsen #1 (Visibility of System Status).
                 Judges with N dynamic criteria have no sense of how much is left.
                 Progress theory (Nunes & Drèze, 2006) shows visible progress bars
                 increase task completion rates by 7–15%. -->
            <Grid Grid.Row="2" ColumnDefinitions="*,Auto" Margin="0,0,0,4">
                <ProgressBar Grid.Column="0"
                             Progress="{Binding EvaluationProgress}"
                             ProgressColor="#6366F1"
                             BackgroundColor="#334155"
                             HeightRequest="3"
                             VerticalOptions="Center" />
                <Label Grid.Column="1"
                       Text="{Binding EvaluationProgressLabel}"
                       FontSize="11" FontAttributes="Bold"
                       TextColor="#94A3B8"
                       Margin="8,0,0,0"
                       VerticalOptions="Center"
                       SemanticProperties.Description="Progreso de evaluación" />
            </Grid>

        </Grid>

        <!-- ══ SCORE FORM ══════════════════════════════════════════ -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="0" Padding="16,0,16,16">

                <!-- Category Sliders -->
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Categories}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="vm:CategoryScore">
                            <Border StrokeShape="RoundRectangle 16"
                                    StrokeThickness="1" Stroke="#1E293B"
                                    BackgroundColor="#1E293B"
                                    Padding="20,16" Margin="0,0,0,12">
                                <VerticalStackLayout Spacing="12">
                                    <!-- Category name + score badge -->
                                    <Grid ColumnDefinitions="*, Auto">
                                        <Label Grid.Column="0"
                                               Text="{Binding Name}"
                                               FontSize="16" FontAttributes="Bold"
                                               TextColor="White"
                                               VerticalOptions="Center" />
                                        <Border Grid.Column="1"
                                                StrokeShape="RoundRectangle 10"
                                                BackgroundColor="#4F46E5"
                                                Padding="10,4">
                                            <Label Text="{Binding Score, StringFormat='{0:F0}'}"
                                                   FontSize="18" FontAttributes="Bold"
                                                   TextColor="White"
                                                   HorizontalOptions="Center" />
                                        </Border>
                                    </Grid>
                                    <!-- Slider
                                         Fix: Minimum changed from 1→0 so the thumb starts at the left
                                         ("sin evaluar") instead of appearing already at a non-zero value.
                                         SemanticProperties added for TalkBack / VoiceOver. -->
                                    <Slider Value="{Binding Score}"
                                            Minimum="0"
                                            Maximum="{Binding MaxScore}"
                                            MinimumTrackColor="#6366F1"
                                            MaximumTrackColor="#334155"
                                            ThumbColor="#6366F1"
                                            SemanticProperties.Description="{Binding Name, StringFormat='Puntaje para {0}'}"
                                            SemanticProperties.Hint="Desliza para ajustar la nota" />
                                    <!-- Scale labels -->
                                    <Grid ColumnDefinitions="*, *">
                                        <Label Grid.Column="0" Text="Sin evaluar"
                                               FontSize="10" TextColor="#475569"
                                               HorizontalOptions="Start" />
                                        <Label Grid.Column="1" Text="Excelente"
                                               FontSize="10" TextColor="#475569"
                                               HorizontalOptions="End" />
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

                <!-- Comments Field -->
                <Border StrokeShape="RoundRectangle 16"
                        StrokeThickness="1" Stroke="#1E293B"
                        BackgroundColor="#1E293B" Padding="20,16">
                    <VerticalStackLayout Spacing="10">
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Grid.Column="0"
                                   Text="Notas (opcional)"
                                   FontSize="14" FontAttributes="Bold"
                                   TextColor="#94A3B8"
                                   VerticalOptions="Center" />
                            <!-- Character counter -->
                            <Label Grid.Column="1"
                                   Text="{Binding Comment.Length, StringFormat='{0}/280', TargetNullValue='0/280'}"
                                   FontSize="11"
                                   TextColor="#475569"
                                   VerticalOptions="Center" />
                        </Grid>
                        <Editor Text="{Binding Comment}"
                                Placeholder="Escribe tus comentarios para el equipo..."
                                PlaceholderColor="#475569"
                                BackgroundColor="Transparent"
                                TextColor="White"
                                FontSize="14"
                                HeightRequest="80"
                                MaxLength="280"
                                SemanticProperties.Description="Campo de notas opcionales para el equipo" />
                    </VerticalStackLayout>
                </Border>

            </VerticalStackLayout>
        </ScrollView>

        <!-- ══ SUBMIT FOOTER ═══════════════════════════════════════ -->
        <VerticalStackLayout Grid.Row="2" Spacing="10" Padding="16,12,16,32"
                             BackgroundColor="#0F172A">
            <Label Text="{Binding StatusMessage}"
                   HorizontalOptions="Center"
                   FontSize="13"
                   TextColor="{Binding IsSubmitting, Converter={StaticResource BoolToColorConverter}}" />
            <!-- Fix: converter parameter order corrected.
                 Format is 'FalseValue|TrueValue':
                   IsSubmitting=false → "Votar ✓"  (button ready)
                   IsSubmitting=true  → "Enviando..." (button busy) -->
            <Button Text="{Binding IsSubmitting, Converter={StaticResource BoolToSubmitTextConverter}, ConverterParameter='Votar ✓|Enviando...'}"
                    Command="{Binding SubmitVoteCommand}"
                    IsEnabled="{Binding IsSubmitting, Converter={StaticResource InvertedBoolConverter}}"
                    BackgroundColor="#6366F1"
                    TextColor="White"
                    FontSize="17" FontAttributes="Bold"
                    HeightRequest="56"
                    CornerRadius="16"
                    SemanticProperties.Description="Enviar calificación del proyecto" />
        </VerticalStackLayout>

    </Grid>
</ContentPage>
