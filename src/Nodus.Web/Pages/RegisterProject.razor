@page "/register"
@using Nodus.Web.Models
@using Nodus.Web.Services
@using Nodus.Shared.Models
@inject ProjectService ProjectService
@inject NavigationManager Navigation

<div class="container fade-in">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary">Nodus Project Registration</h1>
                <p class="text-muted">Register your project for offline voting.</p>
            </div>

            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body p-4">
                    <EditForm Model="@registration" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-3" />

                        <div class="mb-3">
                            <label for="name" class="form-label fw-bold">Project Name</label>
                            <InputText id="name" class="form-control form-control-lg" @bind-Value="registration.Name" placeholder="e.g. AI-Powered Drone" />
                            <ValidationMessage For="@(() => registration.Name)" />
                        </div>

                        <div class="mb-3">
                            <label for="category" class="form-label fw-bold">Category</label>
                            <InputSelect id="category" class="form-select form-select-lg" @bind-Value="registration.Category">
                                <option value="Software">Software</option>
                                <option value="Hardware">Hardware</option>
                                <option value="Innovation">Innovation</option>
                                <option value="Research">Research</option>
                            </InputSelect>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label fw-bold">Description</label>
                            <InputTextArea id="description" class="form-control" @bind-Value="registration.Description" rows="3" placeholder="Brief pitch of your project..." />
                            <ValidationMessage For="@(() => registration.Description)" />
                        </div>

                        <div class="mb-3">
                            <label for="authors" class="form-label fw-bold">Authors</label>
                            <InputText id="authors" class="form-control" @bind-Value="registration.Authors" placeholder="Alice, Bob, Charlie" />
                            <ValidationMessage For="@(() => registration.Authors)" />
                        </div>

                        <div class="mb-4">
                            <label for="github" class="form-label fw-bold">GitHub URL <span class="text-muted fw-normal">(Optional)</span></label>
                            <InputText id="github" class="form-control" @bind-Value="registration.GithubUrl" placeholder="https://github.com/..." />
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Registering...</span>
                                }
                                else
                                {
                                    <span>Register Project</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <p class="text-muted small">
                    <i class="bi bi-wifi-off me-1"></i> Works offline. Data is saved locally.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

@code {
    private ProjectRegistrationDto registration = new ProjectRegistrationDto();
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        var existing = await ProjectService.GetCurrentProjectAsync();
        if (existing != null)
        {
            Navigation.NavigateTo($"/display/{existing.Id}");
        }
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        try 
        {
            var project = new Project
            {
                // Let service generate ID if empty
                Name = registration.Name,
                Category = registration.Category,
                Description = registration.Description,
                Authors = registration.Authors,
                GithubUrl = registration.GithubUrl,
                CreatedAtUtc = DateTime.UtcNow,
                UpdatedAtUtc = DateTime.UtcNow
            };

            var saved = await ProjectService.RegisterProjectAsync(project);
            
            // Artificial delay for UX
            await Task.Delay(500);
            
            Navigation.NavigateTo($"/display/{saved.Id}");
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
