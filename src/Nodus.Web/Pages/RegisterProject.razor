@page "/register"
@using Nodus.Shared.Models
@using Nodus.Web.Services
@inject ProjectService ProjectService
@inject EventService EventService
@inject NavigationManager Navigation

<PageTitle>Register Project | Nodus</PageTitle>

<div class="row justify-content-center">
    <div class="col-12 col-lg-8">
        <div class="card-premium">
            <div class="mb-5 text-center">
                <h1 class="display-5 mb-2">@(isEditMode ? "Edit Project" : "Project Registration")</h1>
                <p class="text-muted lead">@(isEditMode ? "Update your project details below." : "Join the Nodus network and share your innovation.")</p>
                <div class="d-flex justify-content-center mt-3">
                    <span class="badge bg-light text-primary border px-3 py-2 rounded-pill">
                        <i class="bi bi-shield-check me-1"></i> Data saved locally & synced to Atlas
                    </span>
                </div>
            </div>

            <EditForm Model="@project" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="row g-4">
                    <div class="col-md-7">
                        <div class="form-group-premium">
                            <label class="form-label-premium">Project Name</label>
                            <InputText @bind-Value="project.Name" class="form-control-premium w-100" placeholder="e.g. AI-Powered Drone" />
                            <ValidationMessage For="@(() => project.Name)" class="text-danger small mt-1" />
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="form-group-premium">
                            <label class="form-label-premium">Category</label>
                            <InputSelect @bind-Value="project.Category" class="form-control-premium w-100">
                                @if (categories != null)
                                {
                                    @foreach (var cat in categories)
                                    {
                                        <option value="@cat">@cat</option>
                                    }
                                }
                                <option value="Other">Other</option>
                            </InputSelect>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="form-group-premium">
                            <label class="form-label-premium">Project Description</label>
                            <InputTextArea @bind-Value="project.Description" class="form-control-premium w-100" 
                                           rows="4" placeholder="Briefly describe what your project does..." />
                            <ValidationMessage For="@(() => project.Description)" class="text-danger small mt-1" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group-premium">
                            <label class="form-label-premium">Authors</label>
                            <InputText @bind-Value="project.Authors" class="form-control-premium w-100" placeholder="Alice, Bob, Charlie" />
                            <ValidationMessage For="@(() => project.Authors)" class="text-danger small mt-1" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group-premium">
                            <label class="form-label-premium">GitHub URL (Optional)</label>
                            <InputText @bind-Value="project.GithubUrl" class="form-control-premium w-100" placeholder="https://github.com/..." />
                        </div>
                    </div>
                </div>

                <div class="mt-5 pt-3 border-top d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        <i class="bi bi-info-circle me-1"></i> Fields marked as required must be filled.
                    </div>
                    <button type="submit" class="btn-premium px-5" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Registering...</span>
                        }
                        else
                        {
                            <span>@(isEditMode ? "Update Project" : "Register Project")</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "eid")]
    [Parameter] public string? EventId { get; set; }

    private Project project = new();
    private List<string>? categories;
    private bool isSubmitting = false;
    private bool isEditMode = false;

    protected override async Task OnInitializedAsync()
    {
        // Pre-fill EventId from the student QR code URL (eid= query param)
        if (!string.IsNullOrWhiteSpace(EventId))
            project.EventId = EventId;

        // Try to load existing project for editing
        var existingProject = await ProjectService.GetCurrentProjectAsync();
        if (existingProject != null)
        {
            project = existingProject;
            isEditMode = true;
        }

        categories = await EventService.GetCategoriesAsync(EventId);
        if (categories?.Any() == true && !isEditMode)
        {
            project.Category = categories.First();
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        try
        {
            // Ensure EventId is always set before saving
            if (!string.IsNullOrWhiteSpace(EventId))
                project.EventId = EventId;

            var savedProject = await ProjectService.SaveProjectAsync(project);
            if (savedProject != null)
            {
                Navigation.NavigateTo($"/display/{savedProject.Id}");
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
