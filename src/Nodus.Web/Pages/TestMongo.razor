@page "/test-mongo"
@using Nodus.Shared.Abstractions
@using Nodus.Shared.Models
@inject IDatabaseService Db

<h2>üß™ Prueba MongoDB Atlas</h2>

@if (_mensaje != null)
{
    <div style="padding:1rem; background:@(_exito ? "#d4edda" : "#f8d7da"); border-radius:8px; margin:1rem 0;">
        <strong>@(_exito ? "‚úÖ" : "‚ùå") @_mensaje</strong>
    </div>
}

@if (_eventos.Count > 0)
{
    <h4>Eventos en Atlas:</h4>
    <ul>
        @foreach (var e in _eventos)
        {
            <li><strong>@e.Name</strong> ‚Äî ID: @e.Id</li>
        }
    </ul>
}

<button @onclick="InsertarEvento" style="padding:.5rem 1rem; background:#0d6efd; color:white; border:none; border-radius:6px; cursor:pointer; margin-right:.5rem">
    üì• Insertar evento de prueba
</button>

<button @onclick="LeerEventos" style="padding:.5rem 1rem; background:#198754; color:white; border:none; border-radius:6px; cursor:pointer">
    üìã Leer eventos de Atlas
</button>

@code {
    string? _mensaje;
    bool _exito;
    List<Event> _eventos = new();

    async Task InsertarEvento()
    {
        try
        {
            var ev = new Event
            {
                Id = Guid.NewGuid().ToString(),
                Name = $"Evento prueba {DateTime.Now:HH:mm:ss}",
                RubricJson = """{"Dise√±o":10,"Funcionalidad":10}""",
                IsActive = true
            };

            var result = await Db.SaveEventAsync(ev);
            _exito = result.IsSuccess;
            _mensaje = result.IsSuccess
                ? $"Evento guardado en Atlas: {ev.Name}"
                : $"Error: {result.Error}";
        }
        catch (Exception ex)
        {
            _exito = false;
            _mensaje = $"Excepci√≥n: {ex.Message}";
        }
    }

    async Task LeerEventos()
    {
        try
        {
            var result = await Db.GetEventsAsync();
            _exito = result.IsSuccess;
            _eventos = result.ValueOr(new List<Event>())?.ToList() ?? new();
            _mensaje = result.IsSuccess
                ? $"{_eventos.Count} evento(s) encontrados en Atlas"
                : $"Error: {result.Error}";
        }
        catch (Exception ex)
        {
            _exito = false;
            _mensaje = $"Excepci√≥n: {ex.Message}";
        }
    }
}
