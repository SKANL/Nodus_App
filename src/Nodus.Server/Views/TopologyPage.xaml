<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Nodus.Server.ViewModels"
             x:Class="Nodus.Server.Views.TopologyPage"
             Title="TelemetrÃ­a de Red">

    <Grid RowDefinitions="Auto,Auto,*" BackgroundColor="{StaticResource DeepBackground}">
        
        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*, Auto" Padding="40,40,40,10">
            <VerticalStackLayout Grid.Column="0" Spacing="5">
                <Label Text="TopologÃ­a de Enjambre" Style="{StaticResource Headline}" />
                <Label Text="MÃ©tricas de salud y propagaciÃ³n de datos en tiempo real" TextColor="{StaticResource Gray400}" FontSize="14" />
            </VerticalStackLayout>
            
            <Button Grid.Column="1" Text="ACTUALIZAR" 
                    Command="{Binding RefreshTopologyCommand}"
                    Style="{StaticResource SecondaryButton}"
                    Padding="20,0" WidthRequest="120" HeightRequest="40" VerticalOptions="Center"/>
        </Grid>

        <!-- Summary Statistics Section -->
        <Grid Grid.Row="1" Padding="40,10,40,25" ColumnDefinitions="*,*,*,*" ColumnSpacing="15">
            <Border Grid.Column="0" Style="{StaticResource PremiumCard}" Padding="15">
                <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                    <Label Text="ðŸ–§" FontSize="20" HorizontalOptions="Center" TextColor="{StaticResource PrimaryAccent}"/>
                    <Label Text="NODOS TOTALES" FontSize="10" FontAttributes="Bold" TextColor="{StaticResource Gray500}" HorizontalOptions="Center" CharacterSpacing="1"/>
                    <Label Text="{Binding TotalNodes}" FontSize="28" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource PremiumCard}" Padding="15">
                <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                    <Label Text="âœ…" FontSize="20" HorizontalOptions="Center" TextColor="{StaticResource Success}"/>
                    <Label Text="ACTIVOS" FontSize="10" FontAttributes="Bold" TextColor="{StaticResource Gray500}" HorizontalOptions="Center" CharacterSpacing="1"/>
                    <Label Text="{Binding ActiveNodes}" FontSize="28" FontAttributes="Bold" TextColor="{StaticResource Success}" HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Border>

            <Border Grid.Column="2" Style="{StaticResource PremiumCard}" Padding="15">
                <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                    <Label Text="ðŸ”" FontSize="20" HorizontalOptions="Center" TextColor="{StaticResource Warning}"/>
                    <Label Text="RELÃ‰S" FontSize="10" FontAttributes="Bold" TextColor="{StaticResource Gray500}" HorizontalOptions="Center" CharacterSpacing="1"/>
                    <Label Text="{Binding RelayNodes}" FontSize="28" FontAttributes="Bold" TextColor="{StaticResource Warning}" HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Border>

            <Border Grid.Column="3" Style="{StaticResource PremiumCard}" Padding="15">
                <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                    <Label Text="ðŸ“¡" FontSize="20" HorizontalOptions="Center" TextColor="{StaticResource PrimaryAccent}"/>
                    <Label Text="CALIDAD PROM" FontSize="10" FontAttributes="Bold" TextColor="{StaticResource Gray500}" HorizontalOptions="Center" CharacterSpacing="1"/>
                    <Label Text="{Binding AverageConnectionQuality, StringFormat='{0:F0}%'}" FontSize="28" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!-- Nodes List -->
        <Grid Grid.Row="2" Margin="40,0,40,40">
            <!-- Empty State -->
            <VerticalStackLayout IsVisible="{Binding Nodes.Count, Converter={StaticResource InvertedBoolConverter}}" 
                                 VerticalOptions="Center" HorizontalOptions="Center" Spacing="20">
                <Label Text="ðŸŒ«ï¸" FontSize="60" HorizontalOptions="Center" />
                <Label Text="No se identificaron nodos" 
                       TextColor="{StaticResource Gray500}" FontSize="18" FontAttributes="Bold" HorizontalOptions="Center" />
                <Label Text="AsegÃºrese de que sus nodos estÃ©n encendidos y dentro del rango" 
                       TextColor="{StaticResource Gray600}" FontSize="12" HorizontalOptions="Center" />
            </VerticalStackLayout>

            <ScrollView IsVisible="{Binding Nodes.Count}">
                <VerticalStackLayout Spacing="15">
                    <Grid ColumnDefinitions="*, Auto" Margin="5,0,0,5">
                        <Label Grid.Column="0" Text="INVENTARIO DE RED EN VIVO" FontSize="11" FontAttributes="Bold" TextColor="{StaticResource PrimaryAccent}" CharacterSpacing="1.5" VerticalOptions="Center" />
                        <Label Grid.Column="1" Text="{Binding LastUpdateTime, StringFormat='Sincronizado: {0}'}" FontSize="11" TextColor="{StaticResource Gray600}" VerticalOptions="Center"/>
                    </Grid>

                    <CollectionView ItemsSource="{Binding Nodes}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource PremiumCard}" Margin="0,0,0,12" Padding="0">
                                    <Grid ColumnDefinitions="6, *" HeightRequest="100">
                                        <!-- Health Bar -->
                                        <Border Grid.Column="0" 
                                                BackgroundColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                                StrokeThickness="0" />
                                        
                                        <!-- Content -->
                                        <Grid Grid.Column="1" Padding="20,15" ColumnDefinitions="2*, 3*" RowDefinitions="Auto, *">
                                            
                                            <!-- Node Title -->
                                            <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="12" VerticalOptions="Center">
                                                <Label Text="{Binding NodeLabel}" 
                                                       FontAttributes="Bold" FontSize="18" 
                                                       TextColor="{StaticResource White}"/>
                                                
                                                <Border IsVisible="{Binding IsRelay}" 
                                                        BackgroundColor="{StaticResource Gray950}" 
                                                        StrokeThickness="1" Stroke="{StaticResource Warning}"
                                                        Padding="8,2" StrokeShape="RoundRectangle 6" VerticalOptions="Center">
                                                    <Label Text="RELÃ‰" FontSize="9" FontAttributes="Bold" TextColor="{StaticResource Warning}" />
                                                </Border>
                                            </HorizontalStackLayout>
                                            
                                            <Label Grid.Row="0" Grid.Column="1"
                                                   Text="{Binding NodeId}" 
                                                   FontSize="11" TextColor="{StaticResource Gray600}"
                                                   VerticalOptions="Center" HorizontalOptions="End" FontFamily="Consolas" />

                                            <!-- Metrics Layout -->
                                            <Grid Grid.Row="1" Grid.ColumnSpan="2" 
                                                  ColumnDefinitions="*,*,*,*,*" 
                                                  ColumnSpacing="10" Margin="0,15,0,0">
                                                
                                                <VerticalStackLayout Grid.Column="0" Spacing="4">
                                                    <Label Text="LATENCIA" FontSize="9" TextColor="{StaticResource Gray500}" CharacterSpacing="0.5" FontAttributes="Bold"/>
                                                    <Label Text="{Binding AverageLatency, StringFormat='{0:F1}ms'}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource White}"/>
                                                </VerticalStackLayout>

                                                <VerticalStackLayout Grid.Column="1" Spacing="4">
                                                    <Label Text="SEÃ‘AL" FontSize="9" TextColor="{StaticResource Gray500}" CharacterSpacing="0.5" FontAttributes="Bold"/>
                                                    <Label Text="{Binding Rssi, StringFormat='{0}dBm'}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource White}"/>
                                                </VerticalStackLayout>

                                                <VerticalStackLayout Grid.Column="2" Spacing="4">
                                                    <Label Text="ESTADO" FontSize="9" TextColor="{StaticResource Gray500}" CharacterSpacing="0.5" FontAttributes="Bold"/>
                                                    <Label Text="{Binding ConnectionQuality, StringFormat='{0:F0}%'}" FontSize="13" FontAttributes="Bold" 
                                                           TextColor="{Binding ConnectionQuality, Converter={StaticResource QualityToColorConverter}}"/>
                                                </VerticalStackLayout>

                                                <VerticalStackLayout Grid.Column="3" Spacing="4">
                                                    <Label Text="PAQUETES TX" FontSize="9" TextColor="{StaticResource Gray500}" CharacterSpacing="0.5" FontAttributes="Bold"/>
                                                    <Label Text="{Binding PacketsReceived}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource White}"/>
                                                </VerticalStackLayout>

                                                <VerticalStackLayout Grid.Column="4" Spacing="4" HorizontalOptions="End">
                                                    <Label Text="PÃ‰RDIDA" FontSize="9" TextColor="{StaticResource Gray500}" CharacterSpacing="0.5" HorizontalOptions="End" FontAttributes="Bold"/>
                                                    <Label Text="{Binding PacketLossPercentage, StringFormat='{0:F1}%'}" FontSize="13" FontAttributes="Bold" 
                                                           TextColor="{Binding PacketLossPercentage, Converter={StaticResource PacketLossToColorConverter}}"
                                                           HorizontalOptions="End"/>
                                                </VerticalStackLayout>
                                            </Grid>
                                        </Grid>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </ScrollView>
        </Grid>
    </Grid>
</ContentPage>
