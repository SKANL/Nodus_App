# 10. Advanced: BLE Data Transfer & Chunking

> **Status:** Implemented (Phase 3 Completed)
> **Problem:** BLE MTU is typically small (~23-512 bytes). Large media files (images) need robust transfer mechanisms.

## 1. Typically Application-Layer Chunking

Since we cannot rely on the OS to handle large packets automatically across all Android/iOS versions reliably, we implement an **Application-Layer Chunking** protocol locally.

### A. Packet Structure

We use a simple 1-byte prefix to distinguish packet types:

- `0x01`: JSON Data (e.g., Votes, Handshakes)
- `0x02`: Media Data (Images)
- `0xA1`: ACK (Server Acknowledgement)

### B. The Sequence (Media Sync)

1.  **Client** discovers Server and connects.
2.  **Client** monitors RSSI. When RSSI > -60dBm (Mule Mode), sync triggers.
3.  **Client** compresses image (Goal: ~512KB).
4.  **Client** constructs payload: `[0x02][VoteId(16)][ImageBytes...]`.
5.  **Client** splits payload into chunks using `ChunkerService`.
6.  **Client** sends chunks sequentially with 20ms throttling.
7.  **Server** reassembles chunks using `ChunkAssembler`.
8.  **Server** saves image to disk.
9.  **Server** sends ACK Notification: `[0xA1][VoteId(16)]`.
10. **Client** receives ACK and marks vote as `IsMediaSynced = true`.

## 2. MTU Strategy

- **Default MTU:** 180 bytes (Safe minimum for iOS/Android compatibility).
- **Android:** Can request MTU = 512, but we stick to 180 for consistency.

## 3. Implementation Details

### Client Side (`MediaSyncService.cs`)

- Uses `IBleClientService.ReadRssiAsync` to poll signal strength.
- Uses `ChunkerService.Split` to generate chunks.
- Subscribes to `IBleClientService.Notifications` to receive ACKs.

### Server Side (`BleServerService.cs`)

- Uses `ChunkAssembler` to handle incoming streams.
- Writes to `AppData/Media/{EventId}/{VoteId}.jpg`.
- Sends ACK notification upon successful save.
