# 09. Lessons: Prototype Analysis

> **Status:** Active
> **Source:** `PrototipoEvaluacion` (Legacy Code)

## 1. What we can Keep (The "Good Parts")

The prototype `PrototipoEvaluacion` provides a solid foundation for the **Basic Connectivity Layer**. We should port the following directly:

### A. The Tech Stack Integration

- **`MauiProgram.cs`**: The DI setup for `Shiny.BluetoothLE` and `Shiny.BluetoothLE.Hosting` is correct and working.
- **Permissions Logic**: The `CheckAndRequestBluetoothPermissions` method in `MainViewModel` successfully handles the critical Android 12+ (API 31+) permissions `BLUETOOTH_SCAN`, `BLUETOOTH_CONNECT`, and `ACCESS_FINE_LOCATION`.

### B. The Model Wrapper (`ProjectDevice`)

- The signal quality calculation (RSSI to 0-100%) is simple and effective for UI feedback.
- **Keep:** The `SignalStrength`, `SignalQuality`, and `SignalColor` properties for the "Traffic Light" UI.

## 2. What is Missing (The "Gap")

The prototype is a "Scanner/Advertiser", not a "Swarm Node".

### A. Data Layer (Critical)

- **Current:** Stores found devices in memory (`ObservableCollection`).
- **Required:**
  - `sqlite-net-pcl` integration.
  - "Store and Forward" logic: When a packet arrives, it must be persisted to disk _before_ an ACK is sent.

### B. Protocol Logic

- **Current:** Simple BLE Advertisement (`SERVICE_UUID`).
- **Required:**
  - **GATT Characteristics:** The prototype does not define Read/Write characteristics, only the Service UUID. We need a `WriteWithoutResponse` characteristic to accept the JSON envelopes.
  - **Chunking Manager:** `MainViewModel` has no logic to handle payloads > 20-512 bytes. Sending a 2KB Voting Form JSON will fail silently or be truncated without an Application-Layer Chunking mechanism.

### C. Security

- **Current:** Open, unencrypted identifiers.
- **Required:** Ed25519 Signature verification logic before accepting a payload.

## 3. Action Plan

1.  **Refactor:** Extract `MainViewModel` logic into a dedicated `BluetoothService`.
2.  **Enhance:** Replace the simple `IsScanning` boolean with the full **Hero State Machine** (IDLE, LOST, HERO, TIRED).
3.  **Implement:** Add the `MtuChunker` class (See Doc 10) to handle large JSONs.
