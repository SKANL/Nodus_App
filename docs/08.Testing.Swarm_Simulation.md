# 08. Testing: Swarm Simulation

> **Status:** Draft
> **Goal:** Prove the algorithm works before the event.

## 1. The Challenge

You cannot manually test a 50-node swarm with 2 phones. You need **Simulation**.

## 2. Unit Testing the Algorithm (xUnit)

We don't test the Bluetooth hardware; we test the **Logic**.

### Mocking the `IBleManager`

```csharp
public interface IBleManager {
    int GetServerRssi();
    int GetBatteryLevel();
}

// The Test
[Fact]
public void Candidate_Should_NOT_Become_Hero_If_Battery_Low() {
    var mockBle = new Mock<IBleManager>();
    mockBle.Setup(x => x.GetBatteryLevel()).Returns(0.15); // 15%

    var swarm = new SwarmService(mockBle.Object);
    var score = swarm.CalculateHeroScore();

    Assert.Equal(0, score); // Must be zero
}
```

## 3. Integration Testing (The "Virtual Lab")

We create a console app `Nodus.Simulator.exe` that instantiates 100 `VirtualClient` objects in memory.

### The Simulation Loop

1.  **Setup:** Create 1 Server, 100 Clients.
2.  **Topology:** Assign random X,Y coordinates to each client.
3.  **Physics:** Calculate `RSSI` based on `Distance(Server, Client)`.
4.  **Run:**
    - Tick 1: All Clients scan.
    - Tick 1: All Clients scan.
    - Tick 2: **Trickle Check:** Candidates count active neighbors (`k`).
    - Tick 3: **Suppression:** Verify that if `Neighbors >= 2`, Candidate -> SEEKER (Does NOT become Hero).
    - Tick 4: **Election:** Remaining Candidates become Heroes.
    - Tick 5: Verify "Lost" clients find a new "Hero".

## 4. Load Testing the Server

Can the Windows Laptop handle 50 connections per second?

### The "Blaster" Script

A Python or specialized C# script using a PC's Bluetooth adapter to:

1.  Connect to Server.
2.  Write 100 Votes (GATT Writes) as fast as possible.
3.  Disconnect.

- **Metric:** Measure Server CPU usage and Dropped Packets.
