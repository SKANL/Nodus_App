# 04. Security & Identity

> **Status:** Draft
> **Key Concept:** Trustless Offline Verification

## 1. Identity Management

In an offline environment, we cannot hit an Auth0 or Firebase API to verify a token. We need **Crypto-Identity**.

### A. The Setup (Online Phase)

Before the event (at home), the Judge logs in normally via the Internet.

1.  App generates a public/private key pair (`Ed25519` for performance).
2.  Public Key is sent to the Server.
3.  Private Key is stored in the device's Secure Storage (Keystore/Keychain).

### B. The Handshake (Offline Event Day)

When the Judge arrives at the event:

1.  **Event QR:** The Judge scans the "Master Event QR" displayed on the main screen/projector.
    - **Content:** `NODUS:EVENT_ID=xyz;KEY=AES_SHARED_SECRET;BLE_UUID=...`
2.  **Auth Challenge:** The App now knows _how_ to talk to the server (BLE UUID) and _how_ to encrypt packets (Shared Secret).

---

## 2. QR Code Strategy (The Physical Link)

We use QR codes not just for URLs, but as **Data Carriers**.

### Project Identification QR

Placed on the student's table.

- **Format:** `nodus://vote?pid=PROJECT_004&cat=INNOVATION`
- **Function:**
  - Opens the specific evaluation form.
  - Prevents "Fat Finger" errors (selecting the wrong team).
  - **NO Internet required:** The App already downloaded the project list during the initial sync. The QR just acts as a fast lookup key.

---

## 3. Anti-Cheat & Integrity

How do we prevent a student from capturing a Bluetooth packet of a "100/100" score and replaying it 50 times?

### A. Envelope Signing

Every vote payload is signed with the Judge's **Private Key**.
`Signature = Ed25519_Sign(Payload + Timestamp, PrivateKey)`

The Server (which has the Public Key) verifies: "Yes, this really came from Judge Alice, and nobody tampered with the score."

### B. Anti-Replay (Nonce & caching)

1.  **Nonce:** Every packet includes a unique GUID and a Unix Timestamp.
2.  **Server Logic:** The Server maintains a "Seen Packet Cache".
    - If `PacketID` exists in cache -> **REJECT** (Duplicate).
    - If `Timestamp` is older than 2 hours -> **REJECT** (Old/Stale).

### C. Loop Prevention (The Relay Defense)

**Critical for Firefly Protocol:**
Every Relay Node (Link) MUST utilize a short-term **Bloom Filter** or `MemoryCache` of `packet_id`s seen in the last 60 seconds.

- **Rule:** If I have already relayed Packet X, I MUST NOT relay it again.
- **Why?** Prevents "Echo Chambers" where two nodes bounce the same packet back and forth forever.

### C. Encryption (Privacy)

We don't want Students sniffing scores.
Result: `AES_Encrypt(JSON + Signature, Shared_Event_Key)`

- Only the Server (and other Judges with the Event QR) can decrypt the traffic.
- To an outsider, it looks like random noise.
