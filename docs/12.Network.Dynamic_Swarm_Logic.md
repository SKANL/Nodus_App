# 12. Network: Dynamic Swarm Logic (The "Firefly" Protocol)

> **Status:** Proposed
> **Concept:** Ephemeral, rotating chains based on Signal Quality (RSSI) + Randomization.

## 1. The Core Concept

Instead of static "Relays", every node acts like a firefly. It shines (Advertises) for a short burst if it's in a good position, then goes dark (Scan only) to save battery and let others take the load.

## 2. The Factors (Inputs)

Every 10 seconds, a Node calculates its `SuitabilityScore`:

1.  **Server RSSI:** "Can I see the target?" (Primary Factor)
2.  **Battery:** "Can I afford to shout?" (Veto Factor < 20%)
3.  **Random Noise:** "Am I the chosen one?" (Collision Avoidance)

## 3. The State Machine (FSM) V2

### A. States

1.  **SEEKER (Default):** Scanning for Server or Parent. Silent.
2.  **CANDIDATE:** Strong Server Signal detected. Rolling dice...
3.  **LINK (Hero):** Advertising as a Bridge. Relaying packets.
4.  **COOLDOWN:** Just finished being a Link. Resting.

### B. Transitions

#### 1. The "Chain Reaction" Trigger

If `RSSI_To_Server > -75dBm` (Strong):

- **Enter CANDIDATE Mode.**
- Start a random timer `T_wait = Random(5s, 30s)`.
- If `T_wait` expires and _still strong signal_ -> **Become LINK**.

#### 2. The "Load Shedding" (Rotation)

A Node stays in **LINK** mode for a **Max Duration** (e.g., 60 seconds) OR until it relays `N` packets.

- **Trigger:** Time's up!
- **Action:** Stop Advertising.
- **State:** Enter **COOLDOWN** (Prevent re-election for 5 mins).

_Result:_ The "Bridge" role naturally moves physically around the room as devices rotate duties.

#### 3. The "Daisy Chain" (Multi-Hop)

- **Node A** sees Server (-60dBm). Becomes **LINK-1**.
- **Node B** sees **LINK-1** (-65dBm) but NO Server.
- **Node B** becomes **LINK-2** (Advertises "I can reach LINK-1").
- **Node C** connects to **LINK-2**.

> **Constraint:** Max Hop Count = 2. (Node C -> B -> A -> Server).
> Preventing loops is critical. A packet includes `[Trace: C, B, A]`.

## 4. Addressing the Risks

### A. Battery Drain

**Mitigation:** The "Rotation" ensures no single device dies. If 50 devices are present, each might only be a Link for 2 minutes per hour.

### B. iOS Limitation (The "Elephant in the Room")

**Rule:** _This logic ONLY runs when the App is FOREGROUND._

- If the user locks the phone:
  - **Android:** Can continue (with Sticky Notification).
  - **iOS:** IMMEDIATELY sends "Goodbye" packet and stops Advertising. Logic aborts.

## 5. Summary of Algorithm

```csharp
void OnHeartbeat() {
    if (Mode == LINK && TimeActive > 60s) {
        BecomeCooldown();
        return;
    }

    if (Mode == SEEKER && ServerRssi > -70) {
        // Don't switch instantly (thundering herd)
        // Wait random 5-15s
        ScheduleCandidateCheck();
    }
}
```
