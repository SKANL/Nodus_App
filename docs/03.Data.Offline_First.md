# 03. Data: Offline-First Strategy

> **Status:** Draft
> **Key Tech:** SQLite (`sqlite-net-pcl`), System.Text.Json

## 1. The "Zero-Trust in Network" Principle

Nodus assumes the network **does not exist** by default. All data operations (Reads/Writes) happen against the Local Database first. Network sync is a secondary background process.

## 2. Local Database Schema (SQLite)

We use a normalized schema optimized for read-heavy UI and atomic write-heavy voting.

### Key Tables

#### `Events`

Details about the current hackathon/expo.

```csharp
class Event {
    [PrimaryKey] string Id {get;set;} // UUID
    string Name {get;set;}
    string EvaluationRubricJson {get;set;} // Dynamic JSON definition of criteria
    string GlobalSalt {get;set;} // For crypto operations
}
```

#### `Projects`

The "Targets" to be evaluated.

```csharp
class Project {
    [PrimaryKey] string Id {get;set;}
    string Name {get;set;}
    string StandNumber {get;set;}
    string Category {get;set;}
    // Blobs for offline viewing? Only seeing essentials.
}
```

#### `Votes` (The Critical Transaction)

```csharp
class Vote {
    [PrimaryKey] string Id {get;set;} // GUID generated on creation
    string EventId {get;set;}
    string ProjectId {get;set;}
    string JudgeId {get;set;}

    string PayloadJson {get;set;} // The full scores { "Design": 10, "Code": 5 }

    // Multimedia References (Local Paths)
    string LocalPhotoPath {get;set;}
    string LocalAudioPath {get;set;}

    // Sync State
    SyncStatus Status {get;set;} // Pending, Synced, Failed
    DateTime CreatedAtUtc {get;set;}
    DateTime? SyncedAtUtc {get;set;}
}

enum SyncStatus { Pending, Synced, SyncError }
```

---

## 3. Synchronization Logic

### A. The "Lightweight" Payload (Bluetooth)

We **strictly separate** metric data (numbers/text) from heavy media (photos/audio).
When a Judge presses "Submit":

1.  **Atomic Save:** The Vote is saved to SQLite with `Status = Pending`.
2.  **BLE Attempt:** The App attempts to send _strictly_ the `PayloadJson` (Scores) via Bluetooth Swarm.
3.  **Result:**
    - _Success:_ Update `Status = Synced` (only for the textual data).
    - _Failure:_ Keep `Status = Pending`. Background worker retries later.

### B. The "Heavyweight" Sync (Wi-Fi / Wired)

Photos and Voice Notes are **NEVER** sent via Bluetooth.

1.  They reside on the device's internal storage.
2.  When the Judge connects to a real Wi-Fi (e.g., at the coffee break or end of day), a `MediaSyncJob` triggers.
3.  This job uploads the binaries to Supabase Storage and updates the `Vote` record in the Cloud with the URL.

---

## 4. Conflict Resolution & Reliability

### "Append-Only" Philosophy

We typically do not allow editing votes once sent to simplify sync. If a Judge re-evaluates a team:

1.  We create a **new** Vote record (Version 2).
2.  Server Logic handles the "Latest Version Wins" or "Average" calculation.
3.  This avoids the nightmare of merging conflict states on 50 distributed devices.

### Transaction Integrity

All SQLite writes use `RunInTransaction` to ensure that a Vote isn't partially saved (e.g., Header saved but Scores missing) if the battery dies mid-write.
