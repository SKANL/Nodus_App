# 16. Architecture: Current State Analysis

> **Status:** Active Analysis
> **Date:** 2026-02-08
> **Version:** 1.0

## üìã Executive Summary

**Nodus** es un sistema de evaluaci√≥n descentralizado y offline-first dise√±ado para entornos de alta densidad (hackathons, ferias de ciencia). El proyecto est√° implementado en **.NET 10 MAUI** con una arquitectura de 4 aplicaciones principales que se comunican mediante **Bluetooth Low Energy (BLE)** usando el protocolo "Firefly Swarm".

---

## üèóÔ∏è 1. Estructura del Proyecto

### 1.1 Organizaci√≥n de Soluciones

```
nodusApp/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Nodus.Client/      # App m√≥vil para jueces (Android/iOS)
‚îÇ   ‚îú‚îÄ‚îÄ Nodus.Server/      # Dashboard administrativo (Windows)
‚îÇ   ‚îú‚îÄ‚îÄ Nodus.Shared/      # L√≥gica compartida y modelos
‚îÇ   ‚îú‚îÄ‚îÄ Nodus.Web/         # Portal web para estudiantes (Blazor)
‚îÇ   ‚îî‚îÄ‚îÄ Nodus.slnx         # Soluci√≥n principal
‚îú‚îÄ‚îÄ docs/                  # 15 documentos t√©cnicos
‚îú‚îÄ‚îÄ execution_guide.md     # Gu√≠a de ejecuci√≥n
‚îî‚îÄ‚îÄ .agent/                # Configuraci√≥n de agentes
```

### 1.2 Aplicaciones Principales

| Aplicaci√≥n       | Plataforma   | Rol                  | Estado          |
| :--------------- | :----------- | :------------------- | :-------------- |
| **Nodus.Client** | Android/iOS  | Judge Node (Firefly) | ‚úÖ Implementado |
| **Nodus.Server** | Windows      | Admin Node (Queen)   | ‚úÖ Implementado |
| **Nodus.Web**    | Web (Blazor) | Student Registration | üü° B√°sico       |
| **Nodus.Shared** | Library      | Core Logic           | ‚úÖ Implementado |

---

## üéØ 2. Arquitectura de Red: Protocolo Firefly

### 2.1 Concepto Central

El protocolo **"Firefly Swarm"** es una red mesh din√°mica donde los nodos rotan roles para:

- Evitar saturaci√≥n de RF (500 dispositivos Bluetooth activos)
- Conservar bater√≠a
- Auto-curarse ante movimiento de personas

### 2.2 Roles de Nodos

#### A. Admin Node (Queen) - `Nodus.Server`

- **Dispositivo:** Windows Laptop/Tablet
- **Funci√≥n:** Destino final de datos, nunca duerme
- **Servicios:**
  - `BleServerService`: GATT Server para recibir paquetes
  - `VoteAggregatorService`: Procesa y agrega votos
  - Dashboard en tiempo real

#### B. Judge Node (Firefly) - `Nodus.Client`

- **Dispositivo:** Android/iOS Phone
- **Estados FSM:**
  1. **SEEKER** (Default): Escanea silenciosamente
  2. **CANDIDATE**: Eval√∫a si convertirse en relay
  3. **LINK**: Act√∫a como puente (max 60s)
  4. **COOLDOWN**: Descanso forzado (5 min)

- **Servicios Implementados:**
  - `BleClientService`: Cliente BLE con retry logic
  - `RelayHostingService`: GATT Server para relay
  - `SwarmService`: FSM del protocolo Firefly

#### C. Student Node - `Nodus.Web`

- **Dispositivo:** Smartphone del estudiante
- **Funci√≥n:** Registro y display de QR para votaci√≥n
- **Estado:** Implementaci√≥n b√°sica

### 2.3 Algoritmo Trickle (Anti-Colisi√≥n)

```
IF (RSSI > -75dBm) THEN
    Estado = CANDIDATE
    Esperar random(2s, 10s)

    IF (Links_Cercanos >= 2) THEN
        Cancelar promoci√≥n ‚Üí SEEKER
    ELSE
        Estado = LINK (por 60s)
    END IF
END IF
```

---

## üíæ 3. Arquitectura de Datos

### 3.1 Estrategia Offline-First

**Principio:** Asumir que la red NO existe. Todas las operaciones van primero a SQLite local.

### 3.2 Esquema de Base de Datos

#### Tabla: `Events`

```csharp
class Event {
    [PrimaryKey] string Id
    string Name
    string RubricJson              // Criterios de evaluaci√≥n din√°micos
    string GlobalSalt              // Para operaciones crypto
    string SharedAesKeyEncrypted   // Clave AES del evento
    bool IsActive
}
```

#### Tabla: `Projects`

```csharp
class Project {
    [PrimaryKey] string Id         // "PROJ-XYZ"
    string Name
    string EventId
    string Category
    string Description
}
```

#### Tabla: `Votes` (Cr√≠tica)

```csharp
class Vote {
    [PrimaryKey] string Id
    string EventId
    string ProjectId
    string JudgeId
    string PayloadJson             // {"Design": 8, "Code": 9}
    SyncStatus Status              // Pending/Synced/SyncError
    DateTime CreatedAtUtc
    DateTime? SyncedAtUtc
}
```

### 3.3 Sincronizaci√≥n en Dos Fases

1. **Fase Ligera (BLE):**
   - Solo `PayloadJson` (scores num√©ricos)
   - MTU m√°ximo: 180 bytes
   - Encriptado con AES-GCM

2. **Fase Pesada (Wi-Fi):**
   - Fotos y audio (NO por Bluetooth)
   - Upload a Supabase Storage
   - Cuando hay conectividad real

---

## üîê 4. Arquitectura de Seguridad

### 4.1 Identidad Criptogr√°fica

**Problema:** No hay Internet para validar tokens OAuth.

**Soluci√≥n:**

1. **Setup Offline (Pre-evento):**
   - Generar par de llaves Ed25519
   - Public Key ‚Üí Server
   - Private Key ‚Üí Secure Storage (Keychain/Keystore)

2. **Handshake (D√≠a del evento):**
   - Juez escanea QR maestro del evento
   - QR contiene: `AES_Encrypt(Config, Event_Password)`
   - Juez ingresa password ‚Üí Desencripta ‚Üí Obtiene `Shared_AES_Key`

### 4.2 Anti-Replay y Anti-Cheat

#### A. Firma de Paquetes

```csharp
Signature = Ed25519_Sign(Payload + Timestamp, PrivateKey)
```

#### B. Defensa contra Replay

- Cada paquete tiene GUID √∫nico
- Server mantiene cache de `packet_id` vistos
- TTL: 2 horas m√°ximo

#### C. Prevenci√≥n de Loops

- **Max TTL:** 2 hops (Judge ‚Üí Link ‚Üí Server)
- **Bloom Filter:** Nodos recuerdan packet_id por 10 min

### 4.3 Encriptaci√≥n de Payload

```csharp
// Shared/Security/CryptoHelper.cs
byte[] encrypted = AES_GCM_Encrypt(
    plaintext: JSON + Signature,
    key: Shared_Event_Key,
    nonce: Random(12 bytes)
);
```

---

## üß© 5. Servicios Implementados

### 5.1 Nodus.Shared (Core)

| Servicio          | Prop√≥sito         | Estado |
| :---------------- | :---------------- | :----- |
| `DatabaseService` | SQLite wrapper    | ‚úÖ     |
| `CryptoHelper`    | AES-GCM + Ed25519 | ‚úÖ     |
| `PacketTracker`   | Anti-replay cache | ‚úÖ     |
| `ChunkAssembler`  | Fragmentaci√≥n BLE | ‚úÖ     |
| `NodusPacket`     | Protocolo de red  | ‚úÖ     |

### 5.2 Nodus.Client (Judge App)

| Servicio              | Prop√≥sito                 | LOC  | Estado |
| :-------------------- | :------------------------ | :--- | :----- |
| `BleClientService`    | Cliente BLE + retry logic | 507  | ‚úÖ     |
| `RelayHostingService` | GATT Server para relay    | ~300 | ‚úÖ     |
| `SwarmService`        | FSM Firefly               | ~400 | ‚úÖ     |

**ViewModels:**

- `HomeViewModel`: Dashboard del juez
- `JudgeRegistrationViewModel`: Setup inicial
- `VotingViewModel`: Formulario de evaluaci√≥n
- `ScanViewModel`: Lector QR de proyectos

### 5.3 Nodus.Server (Admin Dashboard)

| Servicio                | Prop√≥sito              | LOC  | Estado |
| :---------------------- | :--------------------- | :--- | :----- |
| `BleServerService`      | GATT Server principal  | 183  | ‚úÖ     |
| `VoteAggregatorService` | Procesamiento de votos | ~200 | ‚úÖ     |

**ViewModels:**

- `CreateEventViewModel`: Crear eventos
- `ResultsViewModel`: Visualizaci√≥n de resultados
- `TopologyViewModel`: Mapa de red en tiempo real

---

## üì¶ 6. Stack Tecnol√≥gico

### 6.1 Frameworks y Librer√≠as

| Paquete                       | Versi√≥n | Prop√≥sito           |
| :---------------------------- | :------ | :------------------ |
| `.NET`                        | 10.0    | Runtime principal   |
| `MAUI`                        | Latest  | UI multiplataforma  |
| `Shiny.BluetoothLE`           | Latest  | Driver BLE robusto  |
| `Shiny.BluetoothLE.Hosting`   | Latest  | GATT Server         |
| `sqlite-net-pcl`              | Latest  | ORM SQLite          |
| `CommunityToolkit.Mvvm`       | Latest  | MVVM helpers        |
| `BarcodeScanning.Native.Maui` | Latest  | QR Scanner (ML Kit) |
| `QRCoder`                     | Latest  | Generador QR        |

### 6.2 Arquitectura de C√≥digo

**Patr√≥n:** MVVM + Clean Architecture

```
Services/          # L√≥gica de negocio
ViewModels/        # Presentaci√≥n + Commands
Views/             # UI (XAML)
Models/            # DTOs compartidos
Abstractions/      # Interfaces para testing
```

---

## üöß 7. Estado Actual de Implementaci√≥n

### 7.1 ‚úÖ Completado

1. **Protocolo de Red:**
   - ‚úÖ FSM Firefly con 4 estados
   - ‚úÖ Algoritmo Trickle para anti-colisi√≥n
   - ‚úÖ Fragmentaci√≥n de paquetes (MTU 180)
   - ‚úÖ Retry logic con exponential backoff

2. **Seguridad:**
   - ‚úÖ Encriptaci√≥n AES-GCM
   - ‚úÖ Firma Ed25519
   - ‚úÖ Anti-replay con Bloom Filter
   - ‚úÖ Secure Storage para llaves

3. **Persistencia:**
   - ‚úÖ SQLite con √≠ndices optimizados
   - ‚úÖ Transacciones at√≥micas
   - ‚úÖ Sync status tracking

4. **UI Base:**
   - ‚úÖ Judge registration flow
   - ‚úÖ Voting form
   - ‚úÖ QR scanner
   - ‚úÖ Admin dashboard b√°sico

### 7.2 üü° En Progreso / Necesita Mejora

1. **Nodus.Web (Student Portal):**
   - üü° Implementaci√≥n b√°sica de Blazor
   - ‚ùå Falta: Registro de proyectos
   - ‚ùå Falta: Generaci√≥n de QR din√°micos
   - ‚ùå Falta: Display de "Stand Number" virtual

2. **Testing:**
   - ‚ùå Unit tests para servicios cr√≠ticos
   - ‚ùå Integration tests para BLE
   - ‚ùå Simulaci√≥n de swarm con 50+ dispositivos

3. **Observabilidad:**
   - üü° Logging b√°sico con ILogger
   - ‚ùå Telemetr√≠a de red (RSSI, hops, latencia)
   - ‚ùå Dashboard de topolog√≠a en tiempo real

4. **Resiliencia:**
   - üü° Retry logic implementado
   - ‚ùå Circuit breaker para BLE
   - ‚ùå Graceful degradation si bater√≠a < 20%

### 7.3 ‚ùå Pendiente (Cr√≠tico)

1. **Media Sync:**
   - ‚ùå Upload de fotos a Supabase Storage
   - ‚ùå Compresi√≥n de im√°genes
   - ‚ùå Background job para sync Wi-Fi

2. **Admin Features:**
   - ‚ùå Exportaci√≥n de resultados (CSV/Excel)
   - ‚ùå Gr√°ficos de an√°lisis
   - ‚ùå Audit log de votos

3. **Deployment:**
   - ‚ùå CI/CD pipeline
   - ‚ùå Code signing para Android/iOS
   - ‚ùå Instaladores para Windows

---

## üéØ 8. Pr√≥ximos Pasos Recomendados

### Fase 1: Completar Core Features (1-2 semanas)

1. **Nodus.Web - Student Portal:**
   - Implementar registro de proyectos
   - Generar QR codes din√°micos
   - Display de "Stand Number" en pantalla completa

2. **Media Sync:**
   - Implementar `MediaSyncService`
   - Integrar con Supabase Storage
   - Compresi√≥n de im√°genes con SkiaSharp

3. **Testing:**
   - Unit tests para `CryptoHelper`
   - Integration tests para `BleClientService`
   - Simulaci√≥n de 10 dispositivos en red local

### Fase 2: Optimizaci√≥n y UX (1 semana)

1. **Observabilidad:**
   - Dashboard de topolog√≠a en tiempo real
   - M√©tricas de red (RSSI, packet loss)
   - Alertas de bater√≠a baja

2. **UX Refinement:**
   - Animaciones de estado de red
   - Feedback visual de sync
   - Modo oscuro

### Fase 3: Deployment (1 semana)

1. **CI/CD:**
   - GitHub Actions para builds
   - Code signing automatizado
   - Distribuci√≥n v√≠a TestFlight/Play Store Beta

2. **Documentation:**
   - Manual de usuario
   - Gu√≠a de troubleshooting
   - Video demo

---

## üìä 9. M√©tricas de C√≥digo

### 9.1 Estad√≠sticas Actuales

| M√©trica              | Valor   |
| :------------------- | :------ |
| **Total LOC**        | ~15,000 |
| **Archivos .cs**     | ~50     |
| **Documentos MD**    | 16      |
| **Servicios Core**   | 8       |
| **ViewModels**       | 7       |
| **Modelos de Datos** | 3       |

### 9.2 Complejidad

- **Servicios Cr√≠ticos:**
  - `BleClientService`: 507 LOC (Alta complejidad)
  - `SwarmService`: ~400 LOC (Alta complejidad)
  - `BleServerService`: 183 LOC (Media complejidad)

- **Deuda T√©cnica:**
  - üü° Falta manejo de errores en algunos paths
  - üü° Logging inconsistente en algunos servicios
  - ‚úÖ Arquitectura limpia y bien separada

---

## üîç 10. An√°lisis de Riesgos

### 10.1 Riesgos T√©cnicos

| Riesgo                    | Probabilidad | Impacto | Mitigaci√≥n                                 |
| :------------------------ | :----------- | :------ | :----------------------------------------- |
| **Saturaci√≥n BLE**        | Alta         | Alto    | ‚úÖ Protocolo Trickle implementado          |
| **Bater√≠a agotada**       | Media        | Alto    | üü° Cooldown implementado, falta UI warning |
| **Loops infinitos**       | Baja         | Alto    | ‚úÖ TTL + Bloom Filter                      |
| **Replay attacks**        | Media        | Medio   | ‚úÖ Nonce + Timestamp validation            |
| **iOS background limits** | Alta         | Medio   | ‚ö†Ô∏è Requiere app en foreground              |

### 10.2 Riesgos de Implementaci√≥n

1. **Testing en Escala:**
   - ‚ùå No probado con 100+ dispositivos reales
   - **Mitigaci√≥n:** Simulaci√≥n con emuladores BLE

2. **Plataforma iOS:**
   - ‚ö†Ô∏è Limitaciones de BLE en background
   - **Mitigaci√≥n:** Documentar que jueces iOS deben mantener app abierta

3. **Fragmentaci√≥n Android:**
   - ‚ö†Ô∏è Variaciones en implementaci√≥n BLE por fabricante
   - **Mitigaci√≥n:** Testing en Samsung, Xiaomi, Google Pixel

---

## üìù 11. Conclusiones

### 11.1 Fortalezas

‚úÖ **Arquitectura s√≥lida:** Clean Architecture + MVVM bien implementado
‚úÖ **Protocolo innovador:** Firefly Swarm es √∫nico y elegante
‚úÖ **Seguridad robusta:** Crypto bien dise√±ado
‚úÖ **Offline-first:** SQLite + sync as√≠ncrono bien pensado
‚úÖ **Documentaci√≥n:** 16 docs t√©cnicos detallados

### 11.2 √Åreas de Mejora

üü° **Testing:** Falta cobertura de tests
üü° **Nodus.Web:** Implementaci√≥n b√°sica, necesita features
üü° **Observabilidad:** Falta telemetr√≠a y dashboards
‚ùå **Media Sync:** No implementado
‚ùå **Deployment:** No hay CI/CD

### 11.3 Recomendaci√≥n

**El proyecto est√° en un estado s√≥lido de ~70% completado.** La arquitectura core es excelente y el protocolo Firefly est√° bien implementado. Los pr√≥ximos pasos deben enfocarse en:

1. **Completar Nodus.Web** (Student Portal)
2. **Implementar Media Sync**
3. **Testing exhaustivo**
4. **Deployment pipeline**

**Tiempo estimado para MVP completo:** 3-4 semanas con 1 desarrollador full-time.

---

## üìö 12. Referencias

- `docs/01.Architecture.Vision.md` - Visi√≥n general
- `docs/02.Network.Swarm_Protocol.md` - Protocolo Firefly
- `docs/03.Data.Offline_First.md` - Estrategia de datos
- `docs/04.Security.Identity.md` - Seguridad
- `docs/05.Tech_Stack.NET10.md` - Stack tecnol√≥gico
- `execution_guide.md` - Gu√≠a de ejecuci√≥n

---

**√öltima actualizaci√≥n:** 2026-02-08
**Autor:** An√°lisis arquitect√≥nico automatizado
**Versi√≥n:** 1.0
